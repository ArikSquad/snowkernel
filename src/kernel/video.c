#include "video.h"
#include "kprint.h"
#include "vm.h"
#include <stdint.h>

static inline void outl(uint16_t port, uint32_t val) { __asm__ __volatile__("outl %0,%1" ::"a"(val), "Nd"(port)); }
static inline uint32_t inl(uint16_t port)
{
    uint32_t v;
    __asm__ __volatile__("inl %1,%0" : "=a"(v) : "Nd"(port));
    return v;
}

static uint32_t pci_cfg_read_u32(uint8_t bus, uint8_t slot, uint8_t func, uint8_t off)
{
    uint32_t address = (uint32_t)((1u << 31) | ((uint32_t)bus << 16) | ((uint32_t)slot << 11) | ((uint32_t)func << 8) | (off & 0xFC));
    outl(0xCF8, address);
    return inl(0xCFC);
}

static int find_bochs_vga_bar(uint64_t *phys_base)
{
    for (uint8_t slot = 0; slot < 32; slot++)
    {
        uint32_t id = pci_cfg_read_u32(0, slot, 0, 0x00);
        uint16_t vendor = id & 0xFFFF;
        uint16_t device = (id >> 16) & 0xFFFF;
        if (vendor == 0x1234 && device == 0x1111)
        {
            uint32_t bar0 = pci_cfg_read_u32(0, slot, 0, 0x10);
            if (bar0 & 0x1)
                continue; /* IO BAR, skip */
            uint64_t base = bar0 & ~0xF;
            if (base)
            {
                *phys_base = base;
                return 1;
            }
        }
    }
    return 0;
}

static uint64_t probe_lfb_candidates(uint32_t pitch, uint32_t height)
{
    const uint64_t candidates[] = {0xE0000000ULL, 0xF0000000ULL, 0xFD000000ULL, 0xD0000000ULL};
    uint64_t fb_bytes = (uint64_t)pitch * (uint64_t)height;
    uint64_t pages = (fb_bytes + (PAGE_SIZE - 1)) / PAGE_SIZE;
    for (size_t ci = 0; ci < sizeof(candidates) / sizeof(candidates[0]); ci++)
    {
        uint64_t base = candidates[ci];
        kprintf("[video] probing candidate LFB base=%p\n", (void *)base);
        vm_map_page(base, base, PTE_PRESENT | PTE_WRITABLE);
        volatile uint32_t *p = (volatile uint32_t *)base;
        uint32_t old = p[0];
        p[0] = 0xA5A5A5A5;
        uint32_t rd = p[0];
        p[0] = old;
        if (rd == 0xA5A5A5A5)
        {
            for (uint64_t pg = 1; pg < pages; pg++)
                vm_map_page(base + pg * PAGE_SIZE, base + pg * PAGE_SIZE, PTE_PRESENT | PTE_WRITABLE);
            kprintf("[video] LFB detected at %p (write/read success)\n", (void *)base);
            return base;
        }
    }
    return 0;
}

#define VBE_DISPI_IOPORT_INDEX 0x01CE
#define VBE_DISPI_IOPORT_DATA 0x01CF
#define VBE_DISPI_INDEX_ID 0x0
#define VBE_DISPI_INDEX_XRES 0x1
#define VBE_DISPI_INDEX_YRES 0x2
#define VBE_DISPI_INDEX_BPP 0x3
#define VBE_DISPI_INDEX_ENABLE 0x4
#define VBE_DISPI_INDEX_BANK 0x5
#define VBE_DISPI_INDEX_VIRT_WIDTH 0x6
#define VBE_DISPI_INDEX_VIRT_HEIGHT 0x7
#define VBE_DISPI_INDEX_X_OFFSET 0x8
#define VBE_DISPI_INDEX_Y_OFFSET 0x9

#define VBE_DISPI_DISABLED 0x00
#define VBE_DISPI_ENABLED 0x01
#define VBE_DISPI_LFB_ENABLED 0x40

static inline void outw(uint16_t port, uint16_t val) { __asm__ __volatile__("outw %0,%1" ::"a"(val), "Nd"(port)); }
static inline uint16_t inw(uint16_t port)
{
    uint16_t v;
    __asm__ __volatile__("inw %1,%0" : "=a"(v) : "Nd"(port));
    return v;
}
static void vbe_write(uint16_t index, uint16_t value)
{
    outw(VBE_DISPI_IOPORT_INDEX, index);
    outw(VBE_DISPI_IOPORT_DATA, value);
}
static uint16_t vbe_read(uint16_t index)
{
    outw(VBE_DISPI_IOPORT_INDEX, index);
    return inw(VBE_DISPI_IOPORT_DATA);
}

static video_mode_t gmode = {0};
extern uint8_t _kernel_end; 

int video_init(uint32_t want_w, uint32_t want_h, uint32_t want_bpp)
{
    kprintf("[video] video_init start\n");
    uint16_t id = vbe_read(VBE_DISPI_INDEX_ID);
    kprintf("[video] vbe id read = 0x%x\n", id);
    if (id < 0xB0C0)
    {
        kprintf("[video] Bochs VBE not present (id=%x)\n", id);
        return 0;
    }

    kprintf("[video] disabling vbe before mode set\n");
    vbe_write(VBE_DISPI_INDEX_ENABLE, VBE_DISPI_DISABLED);
    kprintf("[video] set xres=%u yres=%u bpp=%u\n", want_w, want_h, want_bpp);
    vbe_write(VBE_DISPI_INDEX_XRES, (uint16_t)want_w);
    kprintf("[video] wrote xres\n");
    vbe_write(VBE_DISPI_INDEX_YRES, (uint16_t)want_h);
    kprintf("[video] wrote yres\n");
    vbe_write(VBE_DISPI_INDEX_BPP, (uint16_t)want_bpp);
    kprintf("[video] wrote bpp\n");
    vbe_write(VBE_DISPI_INDEX_ENABLE, VBE_DISPI_ENABLED | VBE_DISPI_LFB_ENABLED);
    kprintf("[video] enabled mode (enable reg written)\n");

    uint16_t rw = vbe_read(VBE_DISPI_INDEX_XRES);
    uint16_t rh = vbe_read(VBE_DISPI_INDEX_YRES);
    uint16_t rb = vbe_read(VBE_DISPI_INDEX_BPP);
    if (rw != want_w || rh != want_h || rb != want_bpp)
    {
        kprintf("[video] Requested %ux%u@%u failed, got %ux%u@%u\n", want_w, want_h, want_bpp, rw, rh, rb);
    }
    gmode.width = rw;
    gmode.height = rh;
    gmode.bpp = rb;
    gmode.pitch = rw * (rb / 8);
    kprintf("[video] mode parameters applied width=%u height=%u bpp=%u pitch=%u\n", gmode.width, gmode.height, gmode.bpp, gmode.pitch);
    uint64_t lfb_phys = 0;
    if (find_bochs_vga_bar(&lfb_phys))
    {
        kprintf("[video] PCI BAR0 VGA LFB base=%p\n", (void *)lfb_phys);
    }
    else
    {
        kprintf("[video] PCI BAR detection failed; probing common bases\n");
        lfb_phys = probe_lfb_candidates(gmode.pitch, gmode.height);
    }
    if (!lfb_phys)
    {
        kprintf("[video] LFB discovery failed; disabling graphics (fallback)\n");
        gmode.available = 0;
        return 0;
    }

    uint64_t fb_bytes = (uint64_t)gmode.pitch * (uint64_t)gmode.height;
    uint64_t pages = (fb_bytes + (PAGE_SIZE - 1)) / PAGE_SIZE;
    for (uint64_t pg = 0; pg < pages; pg++)
        vm_map_page(lfb_phys + pg * PAGE_SIZE, lfb_phys + pg * PAGE_SIZE, PTE_PRESENT | PTE_WRITABLE);
    gmode.lfb = (volatile uint8_t *)lfb_phys;
    gmode.available = 1;
    kprintf("[video] mode %ux%u@%u pitch=%u lfb=%p\n", gmode.width, gmode.height, gmode.bpp, gmode.pitch, (void *)gmode.lfb);
    video_clear(0x202030);
    return 1;
}

void video_test_pattern(void)
{
    const video_mode_t *m = video_mode();
    if (!m || !m->available)
        return;
    uint32_t *fb32 = (uint32_t *)m->lfb;
    uint32_t stride = m->pitch / 4;
    for (uint32_t y = 0; y < m->height; y++)
    {
        for (uint32_t x = 0; x < m->width; x++)
        {
            uint8_t v = (uint8_t)((x + y) & 0xFF);
            fb32[y * stride + x] = (v << 16) | ((255 - v) << 8) | v;
        }
    }
    kprintf("[video] video_test_pattern drawn\n");
}

int video_enable_mode(uint32_t want_w, uint32_t want_h, uint32_t want_bpp)
{
    return video_init(want_w, want_h, want_bpp);
}

const video_mode_t *video_mode(void) { return &gmode; }

void video_clear(uint32_t rgb)
{
    if (!gmode.available)
        return;
    uint32_t *p = (uint32_t *)gmode.lfb;
    size_t count = (size_t)gmode.pitch / 4 * gmode.height;
    for (size_t i = 0; i < count; i++)
        p[i] = rgb;
}

void video_putpixel(int x, int y, uint32_t rgb)
{
    if (!gmode.available)
        return;
    if (x < 0 || y < 0 || x >= (int)gmode.width || y >= (int)gmode.height)
        return;
    uint32_t *row = (uint32_t *)(gmode.lfb + y * gmode.pitch);
    row[x] = rgb;
}

static const uint8_t font8x16[128][16] = {
    /* 0..31 control -> blank */
    [0 ... 31] = {0},
    [' '] = {0},
    ['!'] = {0x18,0x3C,0x3C,0x18,0x18,0x18,0x18,0x18,0x18,0x00,0x18,0x18,0x00,0x00,0x00,0x00},
    ['"']= {0x36,0x36,0x36,0x24,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    ['#'] = {0x36,0x36,0x7F,0x36,0x36,0x36,0x7F,0x36,0x36,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    ['$'] = {0x18,0x3E,0x63,0x03,0x1E,0x30,0x60,0x63,0x3E,0x18,0x18,0x00,0x00,0x00,0x00,0x00},
    ['%'] = {0x00,0x63,0x66,0x0C,0x18,0x30,0x60,0x66,0x63,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    ['&'] = {0x1C,0x36,0x36,0x1C,0x38,0x6B,0x66,0x66,0x3B,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    ['\\']={0x60,0x60,0x30,0x30,0x18,0x18,0x0C,0x0C,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    ['('] = {0x18,0x0C,0x06,0x06,0x03,0x03,0x03,0x03,0x06,0x06,0x0C,0x18,0x00,0x00,0x00,0x00},
    [')'] = {0x06,0x0C,0x18,0x18,0x30,0x30,0x30,0x30,0x18,0x18,0x0C,0x06,0x00,0x00,0x00,0x00},
    ['*'] = {0x00,0x18,0x7E,0x3C,0x7E,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    ['+'] = {0x00,0x18,0x18,0x18,0x7E,0x18,0x18,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    [','] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x18,0x30,0x00,0x00,0x00,0x00,0x00},
    ['-'] = {0x00,0x00,0x00,0x00,0x7E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    ['.'] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    ['/'] = {0x00,0x60,0x60,0x30,0x18,0x0C,0x06,0x06,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    ['0'] = {0x3C,0x66,0x63,0x63,0x73,0x7B,0x6F,0x67,0x63,0x63,0x66,0x3C,0x00,0x00,0x00,0x00},
    ['1'] = {0x18,0x1C,0x1E,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x7E,0x00,0x00,0x00,0x00},
    ['2'] = {0x3C,0x66,0x63,0x60,0x60,0x30,0x18,0x0C,0x06,0x03,0x63,0x7F,0x00,0x00,0x00,0x00},
    ['3'] = {0x3C,0x66,0x63,0x60,0x60,0x38,0x38,0x60,0x60,0x63,0x66,0x3C,0x00,0x00,0x00,0x00},
    ['4'] = {0x30,0x38,0x3C,0x36,0x33,0x33,0x7F,0x30,0x30,0x30,0x30,0x78,0x00,0x00,0x00,0x00},
    ['5'] = {0x7F,0x03,0x03,0x1F,0x3F,0x70,0x60,0x60,0x60,0x63,0x66,0x3C,0x00,0x00,0x00,0x00},
    ['6'] = {0x3C,0x66,0x63,0x03,0x1F,0x3F,0x73,0x63,0x63,0x63,0x66,0x3C,0x00,0x00,0x00,0x00},
    ['7'] = {0x7F,0x63,0x63,0x30,0x30,0x18,0x18,0x0C,0x0C,0x06,0x06,0x06,0x00,0x00,0x00,0x00},
    ['8'] = {0x3C,0x66,0x63,0x63,0x66,0x3C,0x66,0x63,0x63,0x63,0x66,0x3C,0x00,0x00,0x00,0x00},
    ['9'] = {0x3C,0x66,0x63,0x63,0x63,0xE7,0xFE,0x7C,0x60,0x60,0x66,0x3C,0x00,0x00,0x00,0x00},
    [':'] = {0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x00,0x00,0x00},
    [';'] = {0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x18,0x18,0x18,0x30,0x00,0x00,0x00,0x00,0x00},
    ['<'] = {0x30,0x18,0x0C,0x06,0x03,0x06,0x0C,0x18,0x30,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    ['='] = {0x00,0x00,0x7E,0x00,0x00,0x7E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    ['>'] = {0x06,0x0C,0x18,0x30,0x60,0x30,0x18,0x0C,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    ['?'] = {0x3C,0x66,0x63,0x60,0x30,0x18,0x18,0x18,0x00,0x18,0x18,0x00,0x00,0x00,0x00,0x00},
    ['@'] = {0x3C,0x66,0x63,0x7B,0x7B,0x7B,0x7B,0x7B,0x03,0x63,0x66,0x3C,0x00,0x00,0x00,0x00},
    /* A-Z */
    ['A'] = {0x18,0x3C,0x66,0x66,0x66,0x7E,0x66,0x66,0x66,0x66,0x66,0xE7,0x00,0x00,0x00,0x00},
    ['B'] = {0x3F,0x63,0x63,0x63,0x63,0x3F,0x63,0x63,0x63,0x63,0x63,0x3F,0x00,0x00,0x00,0x00},
    ['C'] = {0x3C,0x66,0x63,0x03,0x03,0x03,0x03,0x03,0x63,0x63,0x66,0x3C,0x00,0x00,0x00,0x00},
    ['D'] = {0x1F,0x33,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x33,0x1F,0x00,0x00,0x00,0x00},
    ['E'] = {0x7F,0x63,0x03,0x03,0x13,0x1F,0x13,0x03,0x03,0x03,0x63,0x7F,0x00,0x00,0x00,0x00},
    ['F'] = {0x7F,0x63,0x03,0x03,0x13,0x1F,0x13,0x03,0x03,0x03,0x03,0x07,0x00,0x00,0x00,0x00},
    ['G'] = {0x3C,0x66,0x63,0x03,0x03,0x03,0x73,0x73,0x63,0x63,0x66,0x3C,0x00,0x00,0x00,0x00},
    ['H'] = {0xE7,0x66,0x66,0x66,0x66,0x7E,0x66,0x66,0x66,0x66,0x66,0xE7,0x00,0x00,0x00,0x00},
    ['I'] = {0x7E,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x7E,0x00,0x00,0x00,0x00},
    ['J'] = {0x78,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x33,0x33,0x36,0x1C,0x00,0x00,0x00,0x00},
    ['K'] = {0xE7,0x66,0x66,0x36,0x1F,0x0F,0x1F,0x36,0x66,0x66,0x66,0xE7,0x00,0x00,0x00,0x00},
    ['L'] = {0x07,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x63,0x63,0x7F,0x00,0x00,0x00,0x00},
    ['M'] = {0x63,0x77,0x7F,0x7F,0x6B,0x6B,0x63,0x63,0x63,0x63,0x63,0xE7,0x00,0x00,0x00,0x00},
    ['N'] = {0x63,0x67,0x67,0x6F,0x6F,0x7B,0x7B,0x73,0x73,0x63,0x63,0x63,0x00,0x00,0x00,0x00},
    ['O'] = {0x3C,0x66,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x66,0x3C,0x00,0x00,0x00,0x00},
    ['P'] = {0x3F,0x63,0x63,0x63,0x63,0x3F,0x03,0x03,0x03,0x03,0x03,0x07,0x00,0x00,0x00,0x00},
    ['Q'] = {0x3C,0x66,0x63,0x63,0x63,0x63,0x63,0x6B,0x7B,0x7B,0x36,0x6C,0x30,0x00,0x00,0x00},
    ['R'] = {0x3F,0x63,0x63,0x63,0x63,0x3F,0x1F,0x36,0x66,0x66,0x66,0xE7,0x00,0x00,0x00,0x00},
    ['S'] = {0x3C,0x66,0x63,0x03,0x0F,0x1E,0x38,0x70,0x60,0x63,0x66,0x3C,0x00,0x00,0x00,0x00},
    ['T'] = {0x7E,0x5A,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00},
    ['U'] = {0xE7,0x66,0x66,0x66,0x66,0x66,0x66,0x66,0x66,0x66,0x66,0x3C,0x00,0x00,0x00,0x00},
    ['V'] = {0xE7,0x66,0x66,0x66,0x66,0x66,0x3C,0x3C,0x18,0x18,0x18,0x18,0x00,0x00,0x00,0x00},
    ['W'] = {0xE7,0x66,0x66,0x66,0x66,0x6B,0x6B,0x7F,0x7F,0x77,0x63,0x63,0x00,0x00,0x00,0x00},
    ['X'] = {0xE7,0x66,0x66,0x3C,0x18,0x18,0x3C,0x3C,0x66,0x66,0x66,0xE7,0x00,0x00,0x00,0x00},
    ['Y'] = {0xE7,0x66,0x66,0x66,0x3C,0x3C,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00},
    ['Z'] = {0x7F,0x63,0x61,0x30,0x18,0x18,0x0C,0x06,0x06,0x43,0x63,0x7F,0x00,0x00,0x00,0x00},
    /* a-z */
    ['a'] = {0x00,0x00,0x00,0x3C,0x66,0x60,0x7C,0x66,0x66,0x66,0x66,0x7B,0x00,0x00,0x00,0x00},
    ['b'] = {0x07,0x03,0x03,0x3B,0x6F,0x67,0x63,0x63,0x63,0x63,0x67,0x3F,0x00,0x00,0x00,0x00},
    ['c'] = {0x00,0x00,0x00,0x3C,0x66,0x63,0x03,0x03,0x03,0x63,0x66,0x3C,0x00,0x00,0x00,0x00},
    ['d'] = {0x38,0x30,0x30,0x3C,0x76,0x66,0x66,0x66,0x66,0x66,0x76,0x3C,0x00,0x00,0x00,0x00},
    ['e'] = {0x00,0x00,0x00,0x3C,0x66,0x63,0x7F,0x03,0x03,0x63,0x66,0x3C,0x00,0x00,0x00,0x00},
    ['f'] = {0x38,0x6C,0x64,0x04,0x04,0x3E,0x0C,0x0C,0x0C,0x0C,0x0C,0x1E,0x00,0x00,0x00,0x00},
    ['g'] = {0x00,0x00,0x00,0x3C,0x66,0x66,0x66,0x3C,0x30,0x3E,0x63,0x3E,0x00,0x00,0x00,0x00},
    ['h'] = {0x07,0x03,0x03,0x3B,0x6F,0x67,0x63,0x63,0x63,0x63,0x63,0xE7,0x00,0x00,0x00,0x00},
    ['i'] = {0x18,0x18,0x00,0x1C,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00},
    ['j'] = {0x30,0x30,0x00,0x38,0x30,0x30,0x30,0x30,0x30,0x33,0x33,0x1E,0x00,0x00,0x00,0x00},
    ['k'] = {0x07,0x03,0x03,0x63,0x33,0x1B,0x0F,0x1F,0x33,0x33,0x63,0xE7,0x00,0x00,0x00,0x00},
    ['l'] = {0x1C,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00},
    ['m'] = {0x00,0x00,0x00,0x37,0x7F,0x6B,0x6B,0x6B,0x63,0x63,0x63,0xF7,0x00,0x00,0x00,0x00},
    ['n'] = {0x00,0x00,0x00,0x3B,0x6F,0x67,0x63,0x63,0x63,0x63,0x63,0xE7,0x00,0x00,0x00,0x00},
    ['o'] = {0x00,0x00,0x00,0x3C,0x66,0x63,0x63,0x63,0x63,0x63,0x66,0x3C,0x00,0x00,0x00,0x00},
    ['p'] = {0x00,0x00,0x00,0x3F,0x67,0x63,0x63,0x63,0x63,0x63,0x3F,0x03,0x03,0x07,0x00,0x00},
    ['q'] = {0x00,0x00,0x00,0x3C,0x76,0x66,0x66,0x66,0x66,0x66,0x7C,0x70,0x60,0xE0,0x00,0x00},
    ['r'] = {0x00,0x00,0x00,0x3B,0x6F,0x67,0x63,0x03,0x03,0x03,0x03,0x07,0x00,0x00,0x00,0x00},
    ['s'] = {0x00,0x00,0x00,0x3C,0x66,0x63,0x07,0x3E,0x70,0x60,0x63,0x3E,0x00,0x00,0x00,0x00},
    ['t'] = {0x08,0x0C,0x0C,0x3E,0x0C,0x0C,0x0C,0x0C,0x0C,0x6C,0x6C,0x38,0x00,0x00,0x00,0x00},
    ['u'] = {0x00,0x00,0x00,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x73,0x6E,0x00,0x00,0x00,0x00},
    ['v'] = {0x00,0x00,0x00,0xE7,0x66,0x66,0x66,0x3C,0x3C,0x18,0x18,0x18,0x00,0x00,0x00,0x00},
    ['w'] = {0x00,0x00,0x00,0xE7,0x66,0x66,0x6B,0x6B,0x7F,0x7F,0x77,0x63,0x00,0x00,0x00,0x00},
    ['x'] = {0x00,0x00,0x00,0xE7,0x66,0x3C,0x3C,0x18,0x3C,0x3C,0x66,0xE7,0x00,0x00,0x00,0x00},
    ['y'] = {0x00,0x00,0x00,0xE7,0x66,0x66,0x66,0x3C,0x3C,0x18,0x18,0x18,0x30,0x70,0x00,0x00},
    ['z'] = {0x00,0x00,0x00,0x7F,0x63,0x31,0x18,0x0C,0x06,0x43,0x63,0x7F,0x00,0x00,0x00,0x00},
};
static void font_init(void) { /* todo */ }

static uint8_t reverse_bits(uint8_t b) {
    uint8_t r = 0;
    for(int i = 0; i < 8; i++) {
        if (b & (1 << i)) r |= (0x80 >> i);
    }
    return r;
}

void video_draw_char(int x, int y, char c, uint32_t fg, uint32_t bg)
{
    if (!gmode.available)
        return;
    font_init();
    unsigned uc = (unsigned char)c;
    if (uc > 127)
        uc = '?';
    for (int r = 0; r < 16; r++)
    {
        uint8_t bits = font8x16[uc][r];
        for (int col = 0; col < 8; col++) {
            if (bits & (1 << col))
                video_putpixel(x + col, y + r, fg);
            else if (bg != 0xFFFFFFFF)
                video_putpixel(x + col, y + r, bg);
        }
    }
}

void video_draw_text(int x, int y, const char *s, uint32_t fg, uint32_t bg)
{
    int cx = x;
    while (*s)
    {
        if (*s == '\n')
        {
            y += 16;
            cx = x;
            s++;
            continue;
        }
        video_draw_char(cx, y, *s, fg, bg);
        cx += 8;
        s++;
    }
}

void video_fillrect(int x, int y, int w, int h, uint32_t rgb)
{
    if (!gmode.available)
        return;
    if (x < 0)
    {
        w += x;
        x = 0;
    }
    if (y < 0)
    {
        h += y;
        y = 0;
    }
    if (x + w > (int)gmode.width)
        w = gmode.width - x;
    if (y + h > (int)gmode.height)
        h = gmode.height - y;
    if (w <= 0 || h <= 0)
        return;
    for (int r = 0; r < h; r++)
    {
        uint32_t *row = (uint32_t *)(gmode.lfb + (y + r) * gmode.pitch);
        for (int c = 0; c < w; c++)
            row[c + x] = rgb;
    }
}
